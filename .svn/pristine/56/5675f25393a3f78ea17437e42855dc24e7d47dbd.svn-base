import numpy as np
import win32com.client
import re
import os

from model_data import *

class ExcelDataConverter:
    def __init__(self, fileName):
        self.fileName = fileName

    def is_excel_file(self):
        filename_tmp, file_extension = os.path.splitext(self.fileName)
        if file_extension in [".xlsx", ".xls"]:
            return True
        else:
            logWrite('[▷ fail           ] : 엑셀파일이 아닙니다. ' + self.fileName)
            return False

    def read_excel_usedRangeData(self, sheetNum):
        excel = win32com.client.dynamic.Dispatch('Excel.Application')
        excel.Visible = False
        # excel.ScreenUpdating = False
        # excel.AskToUpdateLinks = False
        excel.DisplayAlerts = False

        wb = excel.Workbooks.Open(self.fileName)
        # sheetName = "sheet1"
        # sheet = wb.Sheets(sheetName)
        try:
            sheet = wb.Sheets(sheetNum)
        except Exception as ex:
            logWrite(f'{sheetNum} : 해당 시트가 없습니다. {ex}')
            return False
        # get all data from excel used range
        sheetName = sheet.Name
        usedRangeData = sheet.UsedRange()
        # close excel without save
        wb.Close(False)
        excel.quit()

        return sheetName, usedRangeData

    def is_pension_file(self, usedRangeData):
        if usedRangeData[0][0] == "No." and usedRangeData[0][1] == "신고상태":
            return True
        else:
            logWrite('[▷ fail           ] : 퇴직공제부금 파일이 아닙니다. ' + self.fileName)
            return False

    def convert_pension_data_for_DB(self, sheetName, send_date, usedRangeData):
        filename = self.fileName
        filename_stem = Path(filename).stem
        # get Table range
        usedRangeTable = usedRangeData
        # get Table head and body
        usedRangeTableHead = usedRangeTable[:2]
        usedRangeTableBody = usedRangeTable[2:]
        # columnNames
        columnNames = [""] * len(usedRangeTableHead[0])
        for row in usedRangeTableHead:
            for i, val in enumerate(row):
                if val is None:
                    val = ""
                columnNames[i] += str(val)

        df = pd.DataFrame(usedRangeTableBody, columns=columnNames)
        columns = ['No.', '공제가입번호', '계약명', '소속', '성명', '확정일수', '수정일']
        df = df[columns]
        df = df.groupby(['공제가입번호', '계약명', '소속', '수정일']).agg(
            {'확정일수': 'sum', '성명': 'count'}
        )
        df = df.reset_index()

        df['수정일'] = df['수정일'].apply(lambda x: str(x)[:8])
        df['계약명'] = df['계약명'].apply(lambda x: str(x).strip())
        df['sheet_name'] = sheetName
        df['attachment'] = filename_stem
        df['send_date'] = send_date

        df = df.rename(columns={
            '계약명': '현장명p',
            '소속': '업체명p',
            '공제가입번호': '공제가입번호',
            '수정일': '수정일',
            '확정일수': '확정일수',
            '성명': '인원수',
            'sheet_name': 'sheet_name',
            'attachment': 'attachment',
            'send_date': 'send_date'
        })

        return df


if __name__ == "__main__":
    # Test Module ----------- ilbo file
    fileName = r"D:\Project_Python\webMDChecker\MDChecker\data\220704\테스트.xls"

    excelDataConverter = ExcelDataConverter(fileName)
    sheetName, usedRangeData = excelDataConverter.read_excel_usedRangeData(1)
    # a = excelDataConverter.is_pension_file(usedRangeData)
    df = excelDataConverter.convert_pension_data_for_DB(sheetName, usedRangeData)
    dc = DataControl()
    dc.insert_data_to_db(df, 'mdc_raw_md')
    dc.update_mail_sheetName(fileName, sheetName)
    logWrite(f'[첨부로그 - Save    ] : {fileName} /// {sheetName}')
    dc.conn.commit()
    # df_mst_site = dc.call_df_from_db_with_column_name('mdc_mst_site')
    # df = pd.merge(df, df_mst_site, how='left', on='현장명p')
    # siteCode = df.현장코드.unique()[0]
    # df = df
    # outputFileName = r"D:\Project_Data\JobReport\Files_PLNT\data111.xlsx"
    # with pd.ExcelWriter(outputFileName) as writer:
    #     if len(df) > 0:
    #         df.to_excel(writer, sheet_name="data")



